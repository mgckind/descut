<dom-module id="des-shared-results-help">
<template>
    <style include="shared-styles">

    .size {
      width: 15px;
      height: 15px;
    }


    </style>

    <iron-ajax id="getLogHelpShared"
               auto
               url="/api/log/"
               params={{logParams}}
               handle-as="json"
               last-response="{{logdata}}"
               debounce-duration="300">
    </iron-ajax>


 <des-card-help heading="Help">
    <div class="card-content">
        <b>Contributor:</b> {{username}}
        <br>
        <b>Job Type:</b> {{jobtypes}}
        <br>
        <b>Comment:</b> {{jobcomment}}
        <hr class="des-hr">
        <p> Download all tiles or a text file with the list of files only. In the latter case use:
            <pre>wget -i list.txt</pre> Selectable list below to change between jobs
        </p>

        <hr class="des-hr">
        <!--<paper-item >-->
            <!--<paper-item-body>-->
                <!--See the logfile-->
            <!--</paper-item-body>-->
            <!--<paper-icon-button icon="assignment" on-tap="_seeLog"></paper-icon-button>-->
        <!--</paper-item>-->
        <paper-item >
            <paper-item-body>
                See the logfile
            </paper-item-body>
            <paper-icon-button icon="assignment" on-tap="_seeLog"></paper-icon-button>
        </paper-item>

        <paper-item >
            <paper-item-body>
                See comment
            </paper-item-body>
            <paper-icon-button icon="communication:comment" on-tap="_seeComment"></paper-icon-button>
        </paper-item>

        <paper-item >
            <paper-item-body>
                Download All Tiles
            </paper-item-body>
        <paper-icon-button id="getAllIcon" icon="file-download" on-tap="_getall" ></paper-icon-button>
        </paper-item>

        <paper-item >
            <paper-item-body>
                Get list of files
            </paper-item-body>
            <paper-icon-button icon="assignment-returned" on-tap="_getlist" ></paper-icon-button>
        </paper-item>

        <hr class="des-hr">

        <b> Job list shortcut</b>
        <paper-listbox id="smallJobListShared" >
                <template is="dom-repeat" id="menuShared" items="[[data]]">
                    <paper-item on-focus="_focus">

                        <template is="dom-if" if="{{_completed(item.status)}}">
                        <div class="status size green" item-icon></div>
                        </template>

                        <template is="dom-if" if="{{_pending(item.status)}}">
                        <div class="status size" item-icon></div>
                        </template>

                        <template is="dom-if" if="{{_stop(item.status)}}">
                        <div class="status size red" item-icon></div>
                        </template>

                        <div style="font-size: 8.5px;">&nbsp; &nbsp;[[item.jtitle]]</div>
                    </paper-item>
                </template>
        </paper-listbox>

    </div>
</des-card-help>
    <paper-dialog id="commentDialogSharedHelp">
        <h2>Comment</h2>
        <paper-dialog-scrollable>
            <!--Job : {{jobname}}-->
            {{jobcomment}}
        </paper-dialog-scrollable>
        <div class="buttons">
            <paper-button dialog-confirm autofocus>OK</paper-button>
            <!--<paper-button dialog-confirm autofocus>Edit Comment</paper-button>-->
            <!--<paper-button dialog-dismiss>Cancel</paper-button>-->
        </div>
    </paper-dialog>

    <paper-dialog id="logDialogSharedHelp">
        <h2>Log</h2>
        <paper-dialog-scrollable>
            <paper-card>
                <div class="card-content">
                    Job : {{jobid}}
                    <br>
                    <span>{{logdata}}</span>
                    <des-html html={{logdata}}></des-html>
                </div>
            </paper-card>
        </paper-dialog-scrollable>
        <div class="buttons">
            <!--<paper-button on-tap="viewresults" autofocus>Continue</paper-button>-->
            <!--<paper-button on-tap="_viewToggle" autofocus>View Comment</paper-button>-->
            <paper-button dialog-dismiss>Dismiss</paper-button>
        </div>
    </paper-dialog>

</template>

<script>
    Polymer({
        is: "des-shared-results-help",
        properties: {
            data: {
                type: Array,
            },
            jobid: {
                value : '',
                type : String,
                notify: true,
            },
            jobidFull: {
                value : '',
                type : String,
                notify: true,
            },
            jobtypes: {
                type: String,
                value: 'NULL',
            },
            jobcomment: {
                type: String,
                value: 'NULL',
            },
            logParams:{
                type: String,
                computed: 'processParams(jobidFull)'
            },

            username: {
                type: String,
                value: '',
            },
        },

        processParams: function(jobidFull) {
            return {
                jobid: jobidFull
            };
        },

        _print: function() {
            console.log(this.data);
        },
        _focus: function(e){
            var desResultsHelp = document.querySelectorAll('des-shared-results-help');

            document.getElementById("desResultsShared").jobid=e.model.item.jtitle;
            document.getElementById("desResultsShared").jobidFull=e.model.item.job;
            document.getElementById("desResultsShared").jtypes=e.model.item.jtypes;
            document.getElementById("desResultsShared").username=e.model.item.jcon;
            document.getElementById("desResultsShared").jcomment=e.model.item.jcomment;
//            document.getElementById("desLogShared").jobid=this._returnName(e.model.item.job);
//            document.getElementById("desLogShared").jobidFull=e.model.item.job;
//            document.getElementById("smallJobListShared").selected=e.model.index;

//            document.getElementById("smallJobListLShared").selected=e.model.index;

            desResultsHelp[0].jobid = e.model.item.jtitle;
            desResultsHelp[0].jobidFull = e.model.item.job;
            desResultsHelp[0].username = e.model.item.jcon;
            desResultsHelp[0].jobtypes = e.model.item.jtypes;
            desResultsHelp[0].jobcomment = e.model.item.jcomment;
            desResultsHelp[0].getElementsByTagName("paper-listbox")[0].selected=e.model.index;


            desResultsHelp[1].jobid = e.model.item.jtitle;
            desResultsHelp[1].jobidFull = e.model.item.job;
            desResultsHelp[1].username = e.model.item.jcon;
            desResultsHelp[1].jobtypes = e.model.item.jtypes;
            desResultsHelp[1].jobcomment = e.model.item.jcomment;
            desResultsHelp[1].getElementsByTagName("paper-listbox")[0].selected=e.model.index;
        },
        returnName: function(job) {
            var n1=job.search("__");
            var n2=job.search("{");
            var job0 = job.substring(n1+2,n2-1);
            return job0;
        },
        _returnName: function(job) {
            var n1=job.search("__");
            var n2=job.search("{");
            var job0 = job.substring(n1+2,n2-1);
            return job0;
        },
        _completed: function(status) {
            if (status === "SUCCESS") {return true;}
        },
        _pending: function(status) {
            if (status === "PENDING") {return true;}
        },
        _stop: function(status) {
            if (status != "PENDING" && status != "SUCCESS" ) {return true;}
        },
//        _seeLog: function(e){
//            e.stopPropagation();
//            // var jobid = document.getElementById("desResults").jobid;
//            // var jobidFull = document.getElementById("desResults").jobidFull;
//            var pages = document.getElementById("mainPages");
//            var help = document.getElementById("helpPages");
//            var menu = document.querySelector('paper-');
//            // var desLog = document.getElementById("desLog");
//            //     desLog.jobidFull = jobidFull;
//            //     desLog.jobid = jobid;
//            app.selection="10";
//            pages.selected="10";
//            menu.selected="10";
//            help.selected="10";
//
//        },


        _seeLog: function(e){
            e.stopPropagation();
            // var jobid = document.getElementById("desResults").jobid;
            // var jobidFull = document.getElementById("desResults").jobidFull;
//            var pages = document.getElementById("mainPages");
//            var help = document.getElementById("helpPages");
//            var menu = document.querySelector('paper-menu');
//            // var desLog = document.getElementById("desLog");
//            //     desLog.jobidFull = jobidFull;
//            //     desLog.jobid = jobid;
//            app.selection="7";
//            pages.selected="7";
//            menu.selected="7";
//            help.selected="7";
//            e.stopPropagation();
            var log = document.getElementById('logDialogSharedHelp');
//            this.jobname = this.returnName(e.model.item.job);
            log.open();

        },

        _seeComment: function(e){
            e.stopPropagation();
            // var jobid = document.getElementById("desResults").jobid;
            // var jobidFull = document.getElementById("desResults").jobidFull;
//            var pages = document.getElementById("mainPages");
//            var help = document.getElementById("helpPages");
//            var menu = document.querySelector('paper-menu');
//            // var desLog = document.getElementById("desLog");
//            //     desLog.jobidFull = jobidFull;
//            //     desLog.jobid = jobid;
//            app.selection="7";
//            pages.selected="7";
//            menu.selected="7";
//            help.selected="7";
            var comment = document.getElementById('commentDialogSharedHelp');
//            this.jobname = this.returnName(e.model.item.job);
//            this.jobcomment = e.model.item.jcomment;
            comment.positionTarget = e;
            comment.open();

        },

        _getall: function(){
            var SE = document.getElementById('mainPages').selected=="7";
            var link = document.createElement('a');
            var siid = document.getElementById("desResultsShared").jobid;
            var user = document.getElementById("desResultsShared").username;

            link.href = "/static/uploads/"+user+"/results/"+siid+"/"+siid+".tar.gz";

            if (link.download !== undefined){
                //Set HTML5 download attribute. This will prevent file from opening if supported.
                var fileName = link.href.substring(link.href.lastIndexOf('/') + 1, link.href.length);
                link.download = fileName;
            }
            if (document.createEvent) {
                var e = document.createEvent('MouseEvents');
                e.initEvent('click' ,true ,true);
                link.dispatchEvent(e);
                return true;
            }
            var query = '?download';
            window.open(link.href + query);
        },

        _getlist: function(){
            var link = document.createElement('a');
            var siid = document.getElementById("desResultsShared").jobid;
            var user = document.getElementById("desResultsShared").username;
            link.href = "/static/uploads/"+user+"/results/"+siid+"/list_all.txt";
            if (link.download !== undefined){
                var fileName = link.href.substring(link.href.lastIndexOf('/') + 1, link.href.length);
                link.download = fileName;
            }
            if (document.createEvent) {
                var e = document.createEvent('MouseEvents');
                e.initEvent('click' ,true ,true);
                link.dispatchEvent(e);
                return true;
            }
            var query = '?download';
            window.open(link.href + query);
        },



    });


</script>
</dom-module>
menu