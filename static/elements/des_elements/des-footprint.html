<dom-module id="des-footprint">
<template>
    <style include="shared-styles">
  

.tiletitle {
  visibility: hidden;
}

.box {
    background-color: white;
    border: none;
}

.box:focus {
    outline: none;
}

.box:input {
    outline: none;
}
    </style>


    <section>
    <des-card heading=[[header]]>
    <div class="card-content">
    <div id="tiletitle" class="tiletitle"> Tile: </div>
<canvas id="GlobWebCanvas" class="box" width="600px" height="600px"></canvas> 
    </div>
    </des-card>
    </section>
</template>



<script>

 function loadTiles(filename,color,callback) {   
    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open('GET', filename, true); 
    xobj.onreadystatechange = function () {
    if (xobj.readyState == 4 && xobj.status == "200") {
    callback(color,xobj.responseText);
        }
    };
    xobj.send(null);  
 }

 function checkRA(ra) {
     if (ra > 180.) {
        ra = ra - 360.;
       };
     return ra;
 }
 
 function restoreRA(ra) {
     if (ra < 0) {
        ra = ra + 360.;
       };
     return ra;
 }

 function clearSelection() {
    if(document.selection && document.selection.empty) {
        document.selection.empty();
    } else if(window.getSelection) {
        var sel = window.getSelection();
        sel.removeAllRanges();
    }
}

      Polymer({
      is: "des-footprint",
      properties:{
        name :{
            type: String,
            value:''
        },
        header:{
            type: String,
            value:'DES Footprint',
        },
        tiledata:{
            value: {},
        },
        },
       ready: function(){
require.config({
  baseUrl: '/static/scripts/src/'});
require(['GlobWeb'], function (GlobWeb) 
{	
	var cvs = document.getElementById("GlobWebCanvas");
	//cvs.width = window.innerWidth;
	//cvs.height = window.innerHeight;
	var globe = new GlobWeb.Globe( { canvas: cvs, 
			lighting: false,
			tileErrorTreshold: 3,
            backgroundColor : "#000",
			continuousRendering: false,
            defaultColor: [220.,220.,220.,255.]} );
	    var navigation = new GlobWeb.Navigation(globe, { inertia: false, minDistance: 100000 });
        var canvas = navigation.renderContext.canvas; 
          loadTiles('/static/tiles/grid.json',[0.0,0.0,0.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : mycolor,
			  fill: false,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(true);
		vectorLayer.opacity(0.5);
        globe.addLayer(vectorLayer);
        });
    
    loadTiles('/static/tiles/plane.json',[1.0,0.0,0.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : mycolor,
              strokeWidth: 2.0,
			  fill: false,
              label: 'footprint',
              zIndex: 1000,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(true);
        globe.addLayer(vectorLayer);
        });

    loadTiles('/static/tiles/footprint.json',[0.0,0.0,0.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : mycolor,
              strokeWidth: 5.0,
			  fill: false,
              label: 'footprint',
              zIndex: 100,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(true);
        globe.addLayer(vectorLayer);
        });

    loadTiles('/static/tiles/all_tiles.json',[0.0,0.0,0.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : mycolor,
              strokeWidth: 0.0,
			  fill: false,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(false);
        globe.addLayer(vectorLayer);
        window.all_tiles = vectorLayer;
        });

        loadTiles('/static/tiles/y1a1_tiles.json',[0.0,0.0,1.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : [0.3333333333333333, 0.6588235294117647, 0.40784313725490196,1.],
              strokeWidth: 1.0,
			  fill: false,
              zIndex: 10,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(true);
        globe.addLayer(vectorLayer);
        window.y1_tiles = vectorLayer;
        });
        
        loadTiles('/static/tiles/sva1_tiles.json',[1.0,0.0,1.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : [0.7686274509803922, 0.3058823529411765, 0.3215686274509804,1.],
              strokeWidth: 1.0,
			  fill: false,
              zIndex: 50,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(true);
		vectorLayer.opacity(1.0);
        globe.addLayer(vectorLayer);
        window.sv_tiles = vectorLayer;
        });
        
        loadTiles('/static/tiles/y3a1_tiles.json',[0.0,1.0,1.0,1.0],function(mycolor,response){
	      var vectorLayer = new GlobWeb.VectorLayer({
		  style : new GlobWeb.FeatureStyle({
              strokeColor : [0.2980392156862745, 0.4470588235294118, 0.6901960784313725,1.0],
              strokeWidth: 1.0,
			  fill: false,
              zIndex: 0,
			  })
		  });
		vectorLayer.addFeatureCollection(JSON.parse(response));
		vectorLayer.visible(true);
        globe.addLayer(vectorLayer);
        window.y3_tiles = vectorLayer;
        });


        var PositionZoom = function(ra,dec) {
            var geojsonFeature = {
            "type": "Feature",
        "properties": {},
        "geometry": {
            "type": "Point",
            "coordinates": [ra,dec]
            }
            };
         navigation.zoomTo([ra,dec],500000,1000);
		if (window.tempLayer === undefined){
            var ju = 0;
            }
        else{
            globe.removeLayer( window.tempLayer );
            }
            var tempLayer = new GlobWeb.VectorLayer({
			style : new GlobWeb.FeatureStyle({
					fillColor: [0.,0.,0.,1.],
                    pointMaxSize : 1000
					})
				});
				tempLayer.addFeature(geojsonFeature);
				tempLayer.visible(true);
				globe.addLayer( tempLayer );
                window.tempLayer = tempLayer;
                var title =document.getElementById("tiletitle");
                title.style.visibility = 'hidden';

        };
        window.PositionZoom = PositionZoom;

        var _handleMouseDblClick = function(event)
	    {
        event.stopImmediatePropagation();
        event.preventDefault();
        clearSelection();
		if (event.button == 0)
		{
			var pos = navigation.globe.renderContext.getXYRelativeToCanvas(event);
			var geo = navigation.globe.getLonLatFromPixel( pos[0], pos[1] );
            var max_d = Number.POSITIVE_INFINITY;
            var tile = -1
			if (geo)
			{   
                for (i=0; i < all_tiles.features.length-1; i++){
                    var ra = checkRA(all_tiles.features[i].properties.RA_C);
                    var dec = all_tiles.features[i].properties.DEC_C;
                    var dist = Math.pow(( ra - geo[0]),2) + Math.pow((dec - geo[1]),2);
                    if (dist < max_d){
                        max_d = dist;
                        var tile = i;
                        };
                    }
                var tilename = all_tiles.features[tile].properties.tilename;
                var ra_t = checkRA(all_tiles.features[tile].properties.RA_C);
                var dec_t = all_tiles.features[tile].properties.DEC_C;
				navigation.zoomTo([ra_t,dec_t],500000,1000);
                var title =document.getElementById("tiletitle");
                title.innerHTML = "Tile: " + tilename + "( " +restoreRA(ra_t)+", "+dec_t+" )";
                title.style.visibility = 'visible';

				if (window.tempLayer === undefined){
                    var ju = 0;
                }
                else{
                    globe.removeLayer( window.tempLayer );
                }
                var tempLayer = new GlobWeb.VectorLayer({
				style : new GlobWeb.FeatureStyle({
						fillColor: [1.,1.,0.,1.],
                        strokeColor : [0.0,0.0,0.0,1.0],
                        strokeWidth: 3.5,
						fill: false,
                        zIndex: 90,
					})
				});
				tempLayer.addFeature(all_tiles.features[tile]);
				tempLayer.visible(true);
				globe.addLayer( tempLayer );
                window.tempLayer = tempLayer;
			}
		}
	};

    canvas.addEventListener("dblclick", _handleMouseDblClick);
    window.globe = globe;
    window.navigation = navigation;
			
});
       },
    });


</script>
</dom-module>
