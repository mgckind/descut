
<dom-module id="des-my-jobs">

    <style include="shared-styles">

        /*paper-dialog#dialog-position {*/
            /*width: 100%;*/
            /*height: 80%;*/
            /*margin-left: 40px;*/
            /*margin-right: 40px;*/
            /*margin-top: 20px;*/
            /*position: absolute;*/
        /*}*/
        paper-listbox {
            --paper-listbox-color: var(--primary-text-color);
            width: 100%;
            max-width:1500px;
        }

        paper-icon-item {
            --paper-item-focused: {
            };
            --paper-item-selected: {
                background: var(--paper-amber-50) ;
            };
            --paper-item-focused-before: {
                opacity:0.0;
            };
        }
        .size {
            width: 40px;
            height: 40px;
        }


        @media screen and (max-width: 1300px){
            .helpB {
                display: none;
            }
            .visual {
                display: inherit;
            }
            vaadin-grid {
                height: auto;
                width: 100%;
            }
        }
    </style>

    <template>

        <iron-ajax id="getData"
                   auto
                   url="/api"
                   params='{"part":"fff"}'
                   handle-as="json"
                   on-response="_handleResponse"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="DeleteReq"
                   url="/api"
                   method="DELETE"
                   params='[1,2,3]'
                   on-response="_afterDelete"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="cancelJob"
                   url="/api/canceljob/"
                   method="DELETE"
                   params=''
                   on-response="_afterCancel"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="killJob"
                   method="DELETE"
                   url="/api/myjobs/"
                   params='{{_getJobId(username,jobid)}}'
                   handle-as="json"
                   on-response="_handleTermination"
                   debounce-duration="300">
        </iron-ajax>






        <section>
            <div class="horizontal layout">
            <vaadin-grid id="material" items="{{data}}" size="200">
                <vaadin-grid-selection-column id="auto" auto-select>
                </vaadin-grid-selection-column>

                <vaadin-grid-column flex-grow="0" width="80px">
                    <template class="header">Status</template>
                    <template>
                        <template is="dom-if" if="{{_completed(item.status)}}">
                            <div class="status size green" item-icon></div>
                        </template>

                        <template is="dom-if" if="{{_pending(item.status)}}">
                            <div class="status size" item-icon></div>
                        </template>

                        <template is="dom-if" if="{{_stop(item.status)}}">
                            <div class="status size red" item-icon></div>
                        </template>
                    </template>
                </vaadin-grid-column>

                <vaadin-grid-column flex-grow="6">
                    <template class="header">
                            Job ID
                    </template>
                    <template>

                        <paper-item-body two-line>
                            <div>
                                {{item.jtitle}}
                            </div>
                            <div secondary>
                                {{item.elapsed}} ({{item.time}})
                            </div>
                        </paper-item-body>
                    </template>
                </vaadin-grid-column>


                <vaadin-grid-column flex-grow="1">
                    <template class="header">
                        <vaadin-grid-sorter path="jtypes">
                            <vaadin-grid-filter aria-label="Type" path="jtypes" value="[[_filterType]]">
                                <input placeholder="Type" value="{{_filterType::input}}" focus-target style="width: 100%;">
                            </vaadin-grid-filter>
                        </vaadin-grid-sorter>
                    </template>
                    <template>{{item.jtypes}}</template>
                </vaadin-grid-column>

                <!--<vaadin-grid-column flex-grow="1">-->
                    <!--<template class="header">Cancel</template>-->
                    <!--<template>-->
                        <!--<paper-button class="SeeFilesButton" disabled$="{{!_pending(item.status)}}" raised on-click="_killQuery">Cancel</paper-button>-->
                    <!--</template>-->
                <!--</vaadin-grid-column>-->

                <vaadin-grid-column flex-grow="1">
                    <template class="header">Queries</template>
                    <template>
                        <paper-button class="SeeFilesButton" raised disabled$="{{_isDES(item.jtypes)}}" on-click="_seeQuery">See query</paper-button>
                    </template>
                </vaadin-grid-column>

                <vaadin-grid-column flex-grow="1">
                    <template class="header">Files</template>
                    <template>

                        <paper-button class="SeeFilesButton" disabled$="{{!item.jbool}}" raised on-click="_seeFiles">See Files</paper-button>
                    </template>
                </vaadin-grid-column>


                <vaadin-grid-column flex-grow="2">
                    <template class="header">
                        Result | Cancel
                    </template>
                    <template>

                        <div class="horizontal layout">
                            <paper-icon-button icon="launch" on-tap="viewresults" disabled$="{{_viewjob(item.status, item.jtypes)}}" ></paper-icon-button>
                            <!--<paper-icon-button icon="communication:comment" on-tap="_editCommentOpen" disabled$="{{_viewjob(item.status)}}" ></paper-icon-button>-->
                            <paper-icon-button icon="cancel" on-tap="canceljob" disabled$="{{_canceljob(item.status)}}"></paper-icon-button>

                        </div>
                    </template>
                </vaadin-grid-column>
            </vaadin-grid>


                <des-my-jobs-help class="helpB" style="float: right; width: 18%;"></des-my-jobs-help>

                <!--</paper-icon-item>-->

            <!--<paper-toast class="toast-position" id="toast-cmt-good" text="Comment has been changed" duration="5000"> </paper-toast>-->
            <!--<paper-toast class="toast-position" id="toast-cmt-bad" text="ERROR!. There was an error. Please try again" duration="5000"> </paper-toast>-->
            </div>
            <paper-dialog class="dialog-position" id="JobQueryL" with-backdrop on-iron-overlay-opened="patchOverlay">
                <h2>Job id: {{jobid}}</h2>
                <div style=" border: 1px solid black; padding: 0px; padding-bottom: 15px;">
                    <textarea id="jobQueryBox" autofocus></textarea>
                    <paper-button raised dialog-confirm on-tap="_copyQuery">copy query</paper-button>
                    <paper-button raised dialog-confirm>ok</paper-button><br />
                </div>
            </paper-dialog>

            <paper-dialog class="dialog-position" id="JobFilesL" with-backdrop on-iron-overlay-opened="patchOverlay">
                <h2>Job id: {{jobid}}</h2>
                <div style="padding-bottom: 15px;">

                    <vaadin-grid items="{{myfiles}}" id="material">


                        <vaadin-grid-column flex-grow="1">
                            <template class="header">Filename</template>
                            <template>{{item.file}}</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header">Size</template>
                            <template>{{item.size}}</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header">Download Files</template>
                            <template>
                                <paper-button class="SeeFilesButton" raised on-click="_downloadFile">Download</paper-button>
                            </template>
                        </vaadin-grid-column>

                    </vaadin-grid>

                    <paper-button raised dialog-confirm>ok</paper-button><br />
                </div>
            </paper-dialog>


            <paper-toast class="toast-position" id="toastCopy" text="Query copied to main editor" duration="3000"> </paper-toast>
        </section>
    </template>
</dom-module>
<script>
    function keysrt(key,desc) {
        return function(a,b){
            return desc ? ~~(a[key] < b[key]) : ~~(a[key] > b[key]);
        }
    }
    function loadJSON(callback) {
        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', '/api', true); // Replace 'my_data' with the path to your file
        xobj.onreadystatechange = function () {
            if (xobj.readyState == 4 && xobj.status == "200") {
                // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }

    Polymer({
        is: "des-my-jobs",
        properties: {
            username: {
                type: String,
                value: '',
            },
            jobid: {
                value : '',
                type : String,
                notify: true,
            },
            jobidFull: {
                value : '',
                type : String,
                notify: true,
            },
            logParams:{
                type: String,
                computed: 'processParams(jobidFull)'
            },
            jobname: {
                type: String,
                value: 'NULL',
            },
//            jobcomment: {
//                type: String,
//                value: 'NULL',
//            },
            jobquery: {
                type: String,
                value: '',
            },

        },
//        observers: ['_resetSelection(inverted)'],
        ready: function() {
            var _self = this;
            loc = window.location.host;
            var ws = new WebSocket("ws://"+loc+"/websocket");
            ws.onmessage = function(e) {
                console.log(e.data);
                req = document.getElementById("getData");
                req.generateRequest();
            };

            //loadJSON(function(response) {
            //_self.data = JSON.parse(response);
            //_self.count = _self.data.length;
            //});
        },

        _killQuery: function(e){
            e.preventDefault();
            this.jobid = e.model.item.job;
            this.username = e.model.item.user;
            document.getElementById("killJob").generateRequest();
        },
        attached: function() {
            myJobQuery = document.getElementById("jobQueryBox");
        },
        _getJobId: function(username, jobid){
            return {
                username:username,
                jobid:jobid};
        },
        _handleTermination: function(e){
            document.getElementById("getMyJobs").generateRequest();
        },

        _handleResponse: function(e){
            var _self = this;
            _self.data = e.detail.response;
            console.log('==> data: ', _self.data);
            _self.count = _self.data.length;
            document.querySelectorAll('des-results-help')[0].data = _self.data;
            document.querySelectorAll('des-results-help')[1].data = _self.data;
//            document.querySelector('des-logs-help').data = _self.data;
//            this._genRefreshReq();
        },
//        _resetSelection: function() {
//            this.$.material.selectedItems = [];
//            this.updateStyles();
//        },


        _genRefreshReq: function (){
            var req = document.getElementById("getData");
            req.generateRequest();
//            console.log(document.getElementsByTagName('input').value);
//            document.getElementsByTagName('input').value='';

//            this._resetSelection();
        },
        processParams: function(jobidFull) {
            return {
                jobid: jobidFull
            };
        },


        _afterDelete: function(e){
            var list = document.getElementById("material");
//            this._resetSelection();
//            for (i = 0; i < this.mytemp.length ; i++) {
//                list.deselectItem(this.mytemp[i]);
//            }
            req = document.getElementById("getData");
            req.generateRequest();
//            req2 = document.getElementById("getDataShared");
//            req2.generateRequest();
        },


        returnName: function(job) {
            var n1=job.search("__");
            var n2=job.search("{");
            var job0 = job.substring(n1+2,n2-1);
            console.log('--> job0: ', job0)
            return job0;
        },
        _replaceNum: function(status) {
            if (status === "public" || status === "Public" || status === "Pub" || status === "pub") {
                return 1;
            }
            else if(status === "") {
                return;
            }
            else {
                return 0;
            }
        },
        returnDate: function(date) {
            var date0 = date.substring(4,19);
            return date0;
        },




        _completed: function(status) {
            if (status === "SUCCESS") {return true;}
        },
        _pending: function(status) {
            if (status === "PENDING") {return true;}
        },

        _stop: function(status) {
            if (status != "PENDING" && status != "SUCCESS" ) {return true;}
        },
        _viewjob: function(status, type){
            if (status === "SUCCESS" && this._isDES(type)) {

                return false;
            }
            else{
                return true;
            }
        },
        _viewlog: function(status){
            if (status === "REVOKED") {
                return true;
            }
            else{
                return false;
            }
        },
        _canceljob: function(status){
            if (status === "PENDING") {
                return false;
            }
            else{
                return true;
            }
        },

        _isDES: function(type) {
            if (type === 'DES') {
                return true;
            }
            else {
                return false;
            }
        },



        canceljob: function(e){
            console.log(e.model.item.job);
            var cancelJob = document.getElementById("cancelJob");
            cancelJob.params = {jobid: e.model.item.job};
            cancelJob.generateRequest();
        },

        _afterCancel: function(){
            document.getElementById("getData").generateRequest();
        },




        viewresults: function(e){
//            var log = document.getElementById('log');
//            log.close();
            e.stopPropagation();
            var pages = document.getElementById("mainPages");
            var help = document.getElementById("helpPages");
            var menu = document.querySelector('paper-menu');
            var desResults = document.getElementById("desResults");
            var desResultsHelp = document.querySelectorAll('des-results-help');
//            var desResultsHelpRight = document.getElementById("resultsRight");

//            var list = document.getElementsByTagName("smallJobList")
//            list[0].selected=e.model.index;
//            document.getElementById("smallJobListL").selected=e.model.index;
            desResults.jobid = this.returnName(e.model.item.job);
            desResults.jobidFull = e.model.item.job;
            desResults.username = this.username;
            desResults.jobtypes = e.model.item.jtypes;
//            desResults.jobcomment = e.model.item.jcomment;
//            desResults.job = e.model.item.jcomment;
//            desResults.jobcomment = e.model.item.jcomment;


            desResultsHelp[0] .jobid = e.model.item.jtitle;
            desResultsHelp[0] .jobidFull = e.model.item.job;
            desResultsHelp[0] .username = this.username;
            desResultsHelp[0] .jobtypes = e.model.item.jtypes;
//            desResultsHelp[0] .jobcomment = e.model.item.jcomment;
            desResultsHelp[0].getElementsByTagName("paper-listbox")[0].selected=e.model.index;


            desResultsHelp[1] .jobid = e.model.item.jtitle;
            desResultsHelp[1] .jobidFull = e.model.item.job;
            desResultsHelp[1] .username = this.username;
            desResultsHelp[1] .jobtypes = e.model.item.jtypes;
//            desResultsHelp[1] .jobcomment = e.model.item.jcomment;
            desResultsHelp[1].getElementsByTagName("paper-listbox")[0].selected=e.model.index;


//            desResultsHelpRight .jobid = e.model.item.jtitle;
//            desResultsHelpRight .jobidFull = e.model.item.job;
//            desResultsHelpRight .username = this.username;
//            desResultsHelpRight .jtypes = e.model.item.jtypes;
//            desResultsHelpRight .jobcomment = e.model.item.jcomment;
//            desResults.jobid = this.returnName(e.model.item.job);
//            desResults.jobidFull = e.model.item.job;
            app.selection="7";
            pages.selected="7";
            menu.selected="7";
            help.selected="7";
            console.log(desResults.jobid, desResults.jobidFull, desResults.username, desResults.jobtypes);
        },

        completeHandler: function(){
            console.log('YESSSSS');
//            document.getElementById('desCoadds').clear();
            var req = document.getElementById("getData");
            req.generateRequest();
//            var req2 = document.getElementById("getDataShared");
//            req2.generateRequest();
            document.querySelector('#toast-cmt-good').show();
//            var edit = document.getElementById('editCommentDialog');
//            edit.close();
        },

        errorHandler: function(){
            console.log('NOOOO');
//            document.getElementById('desCoadds').clear();
            document.querySelector('#toast-cmt-bad').show();
        },

//
        viewlog: function(e) {
            e.stopPropagation();
            var log = document.getElementById('log');
            this.jobname = this.returnName(e.model.item.job);
            log.open();

        },



        _isPublic: function(access) {
            if (access === 1) {
                return true;
            }
        },

        _isPrivate: function(access) {
            if (access === 0) {
                return true;
            }
        },
//        shareConfirm: function(){
//            var sdialog = document.getElementById("shareDialog");
//                sdialog.open();
//        },
        _viewToggle: function() {
            view = document.getElementById("viewCommentDialog");
            view.toggle();
        },

        _copyQuery: function(){
            document.querySelector('#toastCopy').show();
            app.editor.setValue(app.jobquerybox.getValue());
            console.log("-> line number: ", app.editor.lineCount());
            setTimeout(function() {
                app.editor.refresh();
                app.editor.focus();
            },20);

        },
        _checkFiles: function(jfiles){
            if (jfiles != '') {return true;}
            else {return false;}
        },
        _downloadFile: function(e){
            e.preventDefault();
            var filename =  e.model.item.file;
            var jobid = this.jobid;
            var user = this.username;
            var link = document.createElement('a');
            link.href = "/static/workdir/"+user+"/" + this.returnName(jobid) +"/"+filename;
            console.log('download from: ', link.href)
            if (link.download !== undefined){
                //Set HTML5 download attribute. This will prevent file from opening if supported.
                var fileName = link.href.substring(link.href.lastIndexOf('/') + 1, link.href.length);
                link.download = fileName;
            }
            if (document.createEvent) {
                var e = document.createEvent('MouseEvents');
                e.initEvent('click' ,true ,true);
                link.dispatchEvent(e);
                return true;
            }
            var query = '?download';
            window.open(link.href + query);

        },
        _seeQuery: function(e){
            e.preventDefault();
            this.jobid = e.model.item.job;
            this.jobquery = e.model.item.jquery;
            console.log('jodid: ', this.jobid, '\nquery: ', this.jobquery);
            document.getElementById('JobQueryL').open();
            app.jobquerybox.setValue(this.jobquery);
            setTimeout(function() {
                app.jobquerybox.refresh();
//            app.jobquerybox.focus();
            },10);
        },
        _seeFiles: function(e){
            e.preventDefault();
            this.jobid = e.model.item.job;
            this.username = e.model.item.user;
            console.log("==> jfiles check: ", e.model.item.jfiles)
            this.jobfiles = JSON.parse(e.model.item.jfiles);
            this.jobsizes = JSON.parse(e.model.item.jsizes);
            console.log("==> files: ", this.jobfiles, "==> size: ", this.jobsizes)

            this.jobs = []//{file:this.jobfiles[0], size:this.jobsizes[0]}] ;
            for (i=0; i< this.jobfiles.length; i++) {
                this.jobs.push({file: this.jobfiles[i], size: this.jobsizes[i]});
            }

            this.myfiles=this.jobs.sort(keysrt('file'));
            console.log('csv files: ', this.myfiles)
            document.getElementById('JobFilesL').open();
        },
        patchOverlay: function (e) {
            if (e.target.withBackdrop) {
                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
            }
        },
    });


</script>
