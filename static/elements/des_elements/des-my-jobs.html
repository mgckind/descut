<dom-module id="des-my-jobs">
<template>
    <style include="shared-styles">
    paper-listbox {
        --paper-listbox-color: var(--primary-text-color);
        width: 100%;
        max-width:1000px;
    }

    paper-icon-item {
        --paper-item-focused: {
        };
        --paper-item-selected: {
        background: var(--paper-amber-50) ;
        };
        --paper-item-focused-before: {
            opacity:0.0;
            };
    }
    .size {
      width: 40px;
      height: 40px;
    }
    </style>


    <iron-ajax id="getData"
    auto
    url="/api"
    params='{"part":"fff"}'
    handle-as="json"
    on-response="_handleResponse"
    debounce-duration="300">
    </iron-ajax>

    <iron-ajax id="DeleteReq"
    url="/api"
    method="DELETE"
    params='[1,2,3]'
    on-response="_afterDelete"
    debounce-duration="300">
    </iron-ajax>

    <iron-ajax id="cancelJob"
    url="/api/canceljob/"
    method="DELETE"
    params=''
    on-response="_afterCancel"
    debounce-duration="300">
    </iron-ajax>

    <section>
	<des-card>
        <div class='card-content'>
                    <div id="ListHeader" style="display:block;">
                    <paper-item  disabled style="font-weight:bold; background:grey; color:black; visibility: visible; max-width:1000px;">
                    <paper-item-body>
                    <div>status &emsp; &emsp; Job id</div>
                    </paper-item-body>
                    <paper-item-body>
                    <div style="margin-left:25px;">Job type</div>
                    </paper-item-body>
                    <div>View | Log | Cancel</div>
                    </paper-item>
                    </div>
                    <div id="DeleteHeader" style="display:none;">
                    <paper-icon-item   style="font-weight:bold; background:pink; color:black; visibility: visible; max-width:1000px;">
                    <paper-icon-button icon="delete" on-tap="deleteall"></paper-icon-button>
                    <paper-item-body>
                    <div> Delete Jobs 
                    </div>
                    </paper-item-body>
                    </paper-icon-item>
                    </div>
               <paper-listbox multi id="jobList">
                    <hr>

                <template is="dom-repeat" id="menu" items="{{data}}">
                    <paper-icon-item>
                     <template is="dom-if" if="{{_completed(item.status)}}">
                    <div class="status size green" item-icon></div>
                    </template>
                     <template is="dom-if" if="{{_pending(item.status)}}">
                    <div class="status size" item-icon></div>
                    </template>
                    <template is="dom-if" if="{{_stop(item.status)}}">
                    <div class="status size red" item-icon></div>
                    </template>
                    <paper-item-body two-line>
                        <div>{{returnName(item.job)}}</div>
                        <div secondary>{{item.elapsed}} ({{returnDate(item.time)}})</div>
                    </paper-item-body two-line>
                    <paper-item-body >
                    <div style="margin-left:10px;">{{item.jtypes}}</div>
                    </paper-item-body>
                    <paper-icon-button icon="launch" on-tap="viewresults" disabled$="{{_viewjob(item.status)}}" ></paper-icon-button>
                    <paper-icon-button icon="assignment" on-tap="viewlog" disabled$="{{_viewlog(item.status)}}"></paper-icon-button>
                    <paper-icon-button icon="cancel" on-tap="canceljob" disabled$="{{_canceljob(item.status)}}"></paper-icon-button>
                    </paper-icon-item>
            </template>
            </paper-listbox>
        </div>
    </des-card>
    </section>
</template>

<script>



 function loadJSON(callback) {   
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', '/api', true); // Replace 'my_data' with the path to your file
    xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
    };
    xobj.send(null);  
 }

      Polymer({
      is: "des-my-jobs",
      properties: {
        username: {
            type: String,
            value: '',
        },
      },
      ready: function() {
        var _self = this;
        loc = window.location.host
        var ws = new WebSocket("wss://"+loc+"/websocket");
         ws.onmessage = function(e) {
           console.log(e.data);
           req = document.getElementById("getData");
           req.generateRequest();
        };

        //loadJSON(function(response) {
        //_self.data = JSON.parse(response);
        //_self.count = _self.data.length;
         //});
      },
      _handleResponse: function(e){
        var _self = this;
        _self.data = e.detail.response;
        _self.count = _self.data.length;
        document.querySelector('des-results-help').data = _self.data;
        document.querySelector('des-logs-help').data = _self.data;
      },
      _afterDelete: function(e){
        var list = document.getElementById("jobList");
        for (i = 0; i < this.mytemp.length ; i++) {
            list.selectIndex(this.mytemp[i]);
        };
        req = document.getElementById("getData");
        req.generateRequest();
      },
      selectall: function(){
        var list = document.getElementById("jobList");
        var listAll = list.selectedValues;
        //if (typeof listAll !== 'undefined') {
        //    var listAll2 = JSON.parse(JSON.stringify(listAll));
          //  console.log(listAll2.length);
           // }
        for (i = 1; i< list.items.length ;i++) { 
            list.selectIndex(i);
        }
        //if (typeof listAll !== 'undefined') {
        //for (i = 0; i< listAll2.length ;i++) { list.selectIndex(listAll2[i]); }
        //};
        app.scrollPageToTop();
        },
      unselectall: function(){
        var list = document.getElementById("jobList");
        var listAll = list.selectedValues;
        if (typeof listAll !== 'undefined') {
            var listAll2 = JSON.parse(JSON.stringify(listAll));
            for (i = 0; i< listAll2.length ;i++) { 
                list.selectIndex(listAll2[i]);
            }
        }
        app.scrollPageToTop();
        },
      deleteall: function(){
        var list = document.getElementById("jobList");
        var listAll = list.selectedValues;
        this.mytemp = JSON.parse(JSON.stringify(listAll));
        var result = confirm("Do you want to delete these "+listAll.length+" jobs? They will be also erased from disk storage");
        var toDel=[];
        if (result){
            for (i = 0; i < this.mytemp.length ; i++) {
                toDel.push(this.returnName(this.data[this.mytemp[i]-1].job));
            };
            req = document.getElementById("DeleteReq");
            req.params = toDel;
            req.generateRequest();
            }
        },
      returnName: function(job) {
        var n1=job.search("__");
        var n2=job.search("{");
        var job0 = job.substring(n1+2,n2-1);
        return job0;
      },
      returnDate: function(date) {
        var date0 = date.substring(4,19);
        return date0;
      },
      _completed: function(status) {
        if (status === "SUCCESS") {return true;}
      },
      _pending: function(status) {
        if (status === "PENDING") {return true;}
      },
      _stop: function(status) {
        if (status != "PENDING" && status != "SUCCESS" ) {return true;}
      },
       _viewjob: function(status){
        if (status === "SUCCESS") {
          return false;
        }
        else{
          return true;
        }
      },
       _viewlog: function(status){
        if (status === "REVOKED") {
          return true;
        }
        else{
          return false;
        }
      },
      _canceljob: function(status){
        if (status === "PENDING") {
          return false;
        }
        else{
          return true;
        }
      },

      canceljob: function(e){
        console.log(e.model.item.job);
        var cancelJob = document.getElementById("cancelJob")
        cancelJob.params = {jobid: e.model.item.job};
        cancelJob.generateRequest();
      },
      _afterCancel: function(){
        document.getElementById("getData").generateRequest();
        },
      viewresults: function(e){
        var pages = document.getElementById("mainPages");
        var help = document.getElementById("helpPages");
        var menu = document.querySelector('paper-menu');
        var desResults = document.getElementById("desResults");
        var desLog = document.getElementById("desLog");
        document.getElementById("smallJobList").selected=e.model.index;
        document.getElementById("smallJobListL").selected=e.model.index;
        document.querySelector('des-my-jobs').unselectall();
            desResults.jobid = this.returnName(e.model.item.job);
            desResults.jobidFull = e.model.item.job;
            desResults.username = this.username;
            desLog.jobid = this.returnName(e.model.item.job);
            desLog.jobidFull = e.model.item.job;
            app.selection="5";
            pages.selected="5";
            menu.selected="5";
            help.selected="5";

      },
      viewlog: function(e) {
        var pages = document.getElementById("mainPages");
        var help = document.getElementById("helpPages");
        var menu = document.querySelector('paper-menu');
        var desLog = document.getElementById("desLog");
        var desResults = document.getElementById("desResults");
        document.querySelector('des-my-jobs').unselectall();
        document.getElementById("smallJobList").selected=e.model.index;
        document.getElementById("smallJobListL").selected=e.model.index;
            desLog.jobidFull = e.model.item.job;
            desLog.jobid= this.returnName(e.model.item.job);
            desResults.jobid = this.returnName(e.model.item.job);
            desResults.jobidFull = e.model.item.job;
            desResults.username = this.username;
            app.selection="6";
            pages.selected="6";
            menu.selected="6";
            help.selected="6";
      },

    });


</script>
</dom-module>
