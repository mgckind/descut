<dom-module id="des-my-jobs">
<template>
    <style>
    paper-card {
        width:100%;
    }
    paper-listbox {
        --paper-listbox-color: var(--primary-text-color);
        width: 100%;
        max-width:800px;
    }
    .jobstatus {
      color: var(--color, orange);
    }
    .status {
      display: inline-block;
      box-sizing: border-box;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--paper-yellow-500);
    }
    .green {background: var(--paper-green-500);}
    .red {background: var(--paper-red-500);}
    </style>


    <iron-ajax
    auto
    url="/api"
    params='{"part":"snippet"}'
    handle-as="json"
    on-response="_handleResponse"
    debounce-duration="300">
    </iron-ajax>

    <section>
    <paper-button on-tap="selectall"> Select All</paper-button>
	<paper-card heading="My Jobs">
        <div class='card-content'>
                    <div id="ListHeader" style="display:block;">
                    <paper-item  disabled style="font-weight:bold; background:grey; color:black; visibility: visible;">
                    <paper-item-body>
                    <div>status &emsp; &emsp; Job id</div>
                    </paper-item-body>
                    <div>View | Log | Cancel</div>
                    </paper-item>
                    </div>
                    <div id="DeleteHeader" style="display:none;">
                    <paper-icon-item   style="font-weight:bold; background:pink; color:black; visibility: visible;">
                    <paper-icon-button icon="delete" on-tap="deleteall"></paper-icon-button>
                    <paper-item-body>
                    <div> Delete Jobs 
                    </div>
                    </paper-item-body>
                    </paper-icon-item>
                    </div>
                    <hr>
            <paper-listbox multi id="jobList">

                <template is="dom-repeat" id="menu" items="{{data}}">
                    <paper-icon-item>
                     <template is="dom-if" if="{{_completed(item.status)}}">
                    <div class="status green" item-icon></div>
                    </template>
                     <template is="dom-if" if="{{_pending(item.status)}}">
                    <div class="status" item-icon></div>
                    </template>
                    <template is="dom-if" if="{{_stop(item.status)}}">
                    <div class="status red" item-icon></div>
                    </template>
                    <paper-item-body two-line>
                        <div>{{returnName(item.job)}}</div>
                        <div secondary>{{item.elapsed}} ({{returnDate(item.time)}})</div>
                    </paper-item-body>
                    <paper-icon-button icon="launch" disabled$="{{_viewjob(item.status)}}"></paper-icon-button>
                    <paper-icon-button icon="assignment" disabled$="{{_viewlog(item.status)}}"></paper-icon-button>
                    <paper-icon-button icon="cancel" disabled$="{{_canceljob(item.status)}}"></paper-icon-button>
                    </paper-icon-item>
            </template>
            </paper-listbox>
        </div>
    </paper-card>
    </section>
</template>

<script>



 function loadJSON(callback) {   
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', '/api', true); // Replace 'my_data' with the path to your file
    xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
    };
    xobj.send(null);  
 }

      Polymer({
      is: "des-my-jobs",
      ready: function() {
        var _self = this;
        //loadJSON(function(response) {
        //_self.data = JSON.parse(response);
        //_self.count = _self.data.length;
         //});
      },
      _handleResponse: function(e){
        var _self = this;
        _self.data = e.detail.response;
        _self.count = _self.data.length;

      },
      selectall: function(){
        var list = document.getElementById("jobList");
        for (i = this.count; i >= 0; i--) { 
            list.select(i);
        }
        app.scrollPageToTop();
        },
      deleteall: function(){
        var list = document.getElementById("jobList");
        var result = confirm("Do you want to delete these jobs? They will be also erased from disk storage");
        if (result){
            console.log('Delete these');
            console.log(list.selectedValues);
            }
        },
      returnName: function(job) {
        var n1=job.search("__");
        var n2=job.search("{");
        var job0 = job.substring(n1+2,n2-1);
        return job0;
      },
      returnDate: function(date) {
        var date0 = date.substring(4,19);
        return date0;
      },
      _completed: function(status) {
        if (status === "SUCCESS") {return true;}
      },
      _pending: function(status) {
        if (status === "PENDING") {return true;}
      },
      _stop: function(status) {
        if (status != "PENDING" && status != "SUCCESS" ) {return true;}
      },
       _viewjob: function(status){
        if (status === "SUCCESS") {
          return false;
        }
        else{
          return true;
        }
      },
       _viewlog: function(status){
        if (status === "REVOKED") {
          return true;
        }
        else{
          return false;
        }
      },
      _canceljob: function(status){
        if (status === "PENDING") {
          return false;
        }
        else{
          return true;
        }
      },

    });


</script>
</dom-module>
